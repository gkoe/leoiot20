#include "esp_https_ota.h"
#define CONFIG_FIRMWARE_UPGRADE_URL "https://www.baaka.io"
#define SERVER_CERT_PEM_START "MIIFVjCCBD6gAwIBAgISBGvlgo7mCuUJYOX05lSG1M6GMA0GCSqGSIb3DQEBCwUAMEoxCzAJBgNVBAYTAlVTMRYwFAYDVQQKEw1MZXQncyBFbmNyeXB0MSMwIQYDVQQDExpMZXQncyBFbmNyeXB0IEF1dGhvcml0eSBYMzAeFw0xOTA1MDIwOTU1MTVaFw0xOTA3MzEwOTU1MTVaMBMxETAPBgNVBAMTCGJhYWthLmlvMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA79qwxyNe1fN10QDlh5me7VcNkW7ymC7VhQE6jJWZkHrEgWn1W3kYs6Vi/+7i362y3TY3Wa2ofWIPAADwhgni/fBEhIMBjpTwk9o3NMwxjW0dg3C2qufDDCh+eobIa//Pc4v6fvEU1V5LoB2fGM1GpCZ62mkCYIY5CQsVgrAol71DWHlPNuCzRzEg9GC9olNN1f5wah8CB0EAuUTg5nU51XAxteLjSnmBb5HK8VE//FsPIpisbvLvwBS5mnkUpYD75Ax/uLQereNRhQcOxWUkEdatVho3+4EdHxYdQh4dUn9rVye/d312bDHp1tu7CGl2hLk99/4/KoswPieDqwzUUQIDAQABo4ICazCCAmcwDgYDVR0PAQH/BAQDAgWgMB0GA1UdJQQWMBQGCCsGAQUFBwMBBggrBgEFBQcDAjAMBgNVHRMBAf8EAjAAMB0GA1UdDgQWBBQoHA0kGFRSpq8OeBW/b1S19DUO5TAfBgNVHSMEGDAWgBSoSmpjBH3duubRObemRWXv86jsoTBvBggrBgEFBQcBAQRjMGEwLgYIKwYBBQUHMAGGImh0dHA6Ly9vY3NwLmludC14My5sZXRzZW5jcnlwdC5vcmcwLwYIKwYBBQUHMAKGI2h0dHA6Ly9jZXJ0LmludC14My5sZXRzZW5jcnlwdC5vcmcvMCEGA1UdEQQaMBiCCGJhYWthLmlvggx3d3cuYmFha2EuaW8wTAYDVR0gBEUwQzAIBgZngQwBAgEwNwYLKwYBBAGC3xMBAQEwKDAmBggrBgEFBQcCARYaaHR0cDovL2Nwcy5sZXRzZW5jcnlwdC5vcmcwggEEBgorBgEEAdZ5AgQCBIH1BIHyAPAAdgBvU3asMfAxGdiZAKRRFf93FRwR2QLBACkGjbIImjfZEwAAAWp4LyFtAAAEAwBHMEUCIQChncXFFBabWdPlptrYt/lM7kwjDvSUOnZd1pru1xrNeQIgI8KE6bzQ+fnZQtrJ87YBCWhp/DWZMvvBUIOZ+5f2VMEAdgBj8tvN6DvMLM8LcoQnV2szpI1hd4+9daY4scdoVEvYjQAAAWp4LyM3AAAEAwBHMEUCIQCYv2WwQ3ifmv/rl067X1WsAQ/o2xAJAKnGkT7GvFCCrgIgaT5bGLinCHdZoMv8YX4ksA9GCaRzhKsdP0bTUzwkzK4wDQYJKoZIhvcNAQELBQADggEBAJDq84dGfjlSsg6l02w3FSV1EKYTFWwHGUNns/wyezWXVUcs4cOXg9AUPvmYBfQfHVVTaf6Ylt+/G2gXjrV+gtGjfL2SgXAOkj7NaN/8rMKaUpYMrfPglz/a1SscbN8HgzmkBJ/tMfg0zdmW5r2fm3bAI+r/ft5I0ZQWuR0ng57xFgG0MMncYqXT3TwTruLcvlnAECrIy97fYLnHa1qDUeu3HMIB5+k69eyPBCB+0AOZ/kXm2W3A5DCxZzLHH7uiZWQogoL+hCfBd1TGB6gYTvq6bw46/moTDK/9AdzgAQjuTClE1aEK1TzUf53yjDPUizopbL6pjes+KipcFfgJbbQ="

esp_err_t do_firmware_upgrade()
{
    esp_http_client_config_t config;
    config.url = CONFIG_FIRMWARE_UPGRADE_URL;
    config.cert_pem = (char *)SERVER_CERT_PEM_START;

    esp_err_t ret = esp_https_ota(&config);
    if (ret == ESP_OK) {
        esp_restart();
    } else {
        return ESP_FAIL;
    }
    return ESP_OK;
}


void app_main(){
    while(1){
        do_firmware_upgrade();
        esp_deep_sleep(60 *1000000);
    }
}